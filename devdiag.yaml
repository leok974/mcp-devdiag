mode: prod:observe
tenant: tasteos
allow_probes:
  - "GET https://api.tasteos.app/healthz"
  - "GET https://api.tasteos.app/api/ready"
  - "HEAD https://cdn.tasteos.app/**"
sampling:
  frontend_events: 0.02
  network_spans: 0.02
  backend_logs: "rate:5/sec"
retention:
  logs_ttl_days: 7
  metrics_ttl_days: 30
rbac:
  provider: jwt
  jwks_url: "https://auth.example.com/.well-known/jwks.json"
  roles:
    - name: reader
      can: [get_status, get_network_summary, get_metrics, get_request_diagnostics]
    - name: operator
      can: ["*"]
redaction:
  headers_deny: [authorization, cookie, set-cookie, x-api-key]
  path_params_regex: ["^/users/\\d+", "^/tokens/[^/]+"]
  query_keys_deny: [token, key, code]
shipping:
  otlp_endpoint: "http://otel-collector:4318"
  s3_bucket: "s3://diag-bundles/tasteos/"

# Closed-loop learning configuration
learn:
  enabled: true
  store: "postgresql+psycopg://devdiag:DevDiag2025SecurePass!@localhost:5432/devdiag"
  privacy:
    hash_targets: true               # hash base_url to target_hash
    keep_evidence_keys: ["csp", "xfo", "framework", "server", "routes"]
  retention_days: 180
  min_support: 2
  alpha: 0.6                         # confidence α for support
  beta: 0.7                          # confidence β for similarity

# Generalized diagnostic probe configuration
diag:
  # Portal root selectors for frameworks (Next.js, React portals, etc.)
  portal_roots:
    - "#__PORTAL_ROOT__"
    - "#toast-root"
    - "#__NEXT_PORTAL__"
    - "#portal"

  # Overlay detection thresholds (fraction of viewport)
  overlay_min_width_pct: 0.85
  overlay_min_height_pct: 0.50

  # Additional selectors for overlay detection
  overlay_selectors:
    - "[data-overlay]"
    - ".modal-backdrop"
    - ".app-overlay"
    - "[role='dialog']"

  # Expected iframe configuration
  iframe_expected:
    - id: "chat-frame"
      sandbox_must_not_include: ["allow-same-origin"]
      ready_message: "ready"

  # Embed handshake configuration
  handshake:
    message_types: ["chat:ready", "widget:ready", "embed:ready"]
    timeout_ms: 3000

  # Framework detection patterns (console log regex)
  framework:
    detect_console_regex:
      react: "\\[boot\\].*react .* react-dom|React.*version|react@"
      vue: "Vue.*version|vue@"
      svelte: "Svelte|svelte@"
      angular: "Angular.*version|@angular"
      nextjs: "Next\\.js|next@"

  # CSP validation rules
  csp:
    must_include:
      - directive: "frame-ancestors"
        any_of: ["'self'", "https://*.tasteos.app"]
    forbidden_xfo: ["DENY"]
