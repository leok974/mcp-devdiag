name: DevDiag Export Dry-Run

on:
  pull_request:
    types: [labeled]

jobs:
  export-dryrun:
    if: github.event.label.name == 'incident'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install mcp-devdiag
        run: |
          pip install -e .
      
      - name: Export incident snapshot (dry-run)
        env:
          DEVDIAG_URL: ${{ secrets.DEVDIAG_URL }}
          OPERATOR_JWT: ${{ secrets.DEVDIAG_OPERATOR_JWT }}
        run: |
          curl -s -X POST "$DEVDIAG_URL/mcp/devdiag/export_snapshot" \
            -H "Authorization: Bearer $OPERATOR_JWT" \
            -H "Content-Type: application/json" \
            -d '{
              "payload": {
                "problems": ["INCIDENT_DRYRUN"],
                "score": 1,
                "pr_number": "${{ github.event.pull_request.number }}",
                "pr_title": "${{ github.event.pull_request.title }}"
              },
              "tenant": "ci-dryrun",
              "export_config": {
                "s3_bucket": "mcp-devdiag-artifacts",
                "region": "us-east-1",
                "key_prefix": "ci/"
              }
            }' | jq '.'
      
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… DevDiag export dry-run completed. Check S3 bucket `mcp-devdiag-artifacts` for snapshot.'
            })
